name: FreeRADIUS config and DB check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: radius
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y freeradius freeradius-mysql mysql-client

      - name: Wait for DB
        run: |
          for i in {1..60}; do
            mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" && break || sleep 2
          done

      - name: Create radius user and grant
        run: |
          mysql -h 127.0.0.1 -uroot -proot -e "CREATE USER IF NOT EXISTS \"radius\"@\"%\" IDENTIFIED BY \"radius\"; GRANT ALL PRIVILEGES ON radius.* TO \"radius\"@\"%\"; FLUSH PRIVILEGES;"

      - name: Import FreeRADIUS schema
        run: |
          mysql -h 127.0.0.1 -uroot -proot radius < /etc/freeradius/3.0/mods-config/sql/main/mysql/schema.sql
          mysql -h 127.0.0.1 -uroot -proot radius < /etc/freeradius/3.0/mods-config/sql/main/mysql/setup.sql || true

      - name: Apply repo configs
        run: |
          # Copy SQL config - gunakan configs/sql (file yang ada)
          sudo cp configs/sql /etc/freeradius/3.0/mods-available/sql
          
          # Update config dengan sed - pastikan format benar
          sudo sed -i 's|^server = .*|server = "127.0.0.1"|' /etc/freeradius/3.0/mods-available/sql
          sudo sed -i 's|^port = .*|port = 3306|' /etc/freeradius/3.0/mods-available/sql
          sudo sed -i 's|^login = .*|login = "radius"|' /etc/freeradius/3.0/mods-available/sql
          sudo sed -i 's|^password = .*|password = "radius"|' /etc/freeradius/3.0/mods-available/sql
          sudo sed -i 's|^radius_db = .*|radius_db = "radius"|' /etc/freeradius/3.0/mods-available/sql
          
          # Enable SQL module
          sudo ln -sf /etc/freeradius/3.0/mods-available/sql /etc/freeradius/3.0/mods-enabled/sql
          
          # Copy sites-default if exists
          if [ -f configs/sites-default ]; then
            sudo cp configs/sites-default /etc/freeradius/3.0/sites-available/default
          fi
          
          # Set permissions
          sudo chown -R freerad:freerad /etc/freeradius/3.0

      - name: Verify configuration parses and DB connectivity
        run: |
          # Test FreeRADIUS configuration
          sudo freeradius -C || {
            echo "Configuration test failed!"
            sudo freeradius -XC 2>&1 | head -50
            exit 1
          }
          echo "âœ… FreeRADIUS configuration is valid!"
