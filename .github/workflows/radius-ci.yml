name: FreeRADIUS config check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FreeRADIUS
        run: |
          sudo apt-get update -y
          sudo apt-get install -y freeradius freeradius-mysql

      - name: Backup default configs
        run: |
          sudo cp -an /etc/freeradius/3.0/mods-available/sql /etc/freeradius/3.0/mods-available/sql.bak || true
          sudo cp -an /etc/freeradius/3.0/sites-available/default /etc/freeradius/3.0/sites-available/default.bak || true

      - name: Apply repo configs
        run: |
          sudo cp -a configs/sql /etc/freeradius/3.0/mods-available/sql
          sudo ln -sf /etc/freeradius/3.0/mods-available/sql /etc/freeradius/3.0/mods-enabled/sql
          sudo cp -a configs/sites-default /etc/freeradius/3.0/sites-available/default

      - name: Verify configuration parses
        run: |
          sudo freeradius -Cx -lstdout
